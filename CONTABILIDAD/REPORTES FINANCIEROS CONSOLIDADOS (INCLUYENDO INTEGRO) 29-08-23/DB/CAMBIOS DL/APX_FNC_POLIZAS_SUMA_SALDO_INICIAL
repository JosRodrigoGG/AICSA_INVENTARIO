create or replace FUNCTION     APX_FNC_POLIZAS_SUMA_SALDO_INICIAL
(
	V_EMPRESAS VARCHAR2,
	V_UNIDADES VARCHAR2,
	V_FECHA_INICIO VARCHAR2,
    V_INDICADOR NUMBER
)
RETURN NUMBER IS
    CURSOR C_SALDO_INICIO IS
        SELECT
            sum(DECODE(B.DB_HB,'D',B.VALOR, (B.VALOR * -1))) AS VALOR
        FROM SAF.CON_POLIZAS A, SAF.CON_POLIZASD B, SAF.CON_CTASXEJER C,CON_INDICADORES_FORMULAS D
        WHERE B.CODIGO_EMPRESA = A.CODIGO_EMPRESA
        AND B.EJERCICIO = A.EJERCICIO
        AND B.LIBRO = A.LIBRO
        AND B.COD_TIPOL = A.COD_TIPOL
        AND B.MES = A.MES
        AND B.NRO_POLIZA = A.NRO_POLIZA
        AND C.CODIGO_EMPRESA = B.CODIGO_EMPRESA
        AND C.EJERCICIO = B.EJERCICIO
        AND C.COD_CTA = B.COD_CTA
        AND B.COD_CTA = D.COD_CTA
        AND B.CODIGO_GASTO = D.CODIGO_GASTO
        --AND B.COD_CTA = '11201001'
        AND A.COD_TIPOL NOT IN (30,1)
        AND D.ID_INDICADOR = V_INDICADOR
        AND D.FUNCION = '+' -- DMLOPEZ 30-11-2023
        AND B.CODIGO_EMPRESA IN
        (
			SELECT
				REPLACE(REPLACE(REGEXP_SUBSTR(V_EMPRESAS, '[^\|]+', 1, level), '[',''), ']', '') AS CODIGO
			FROM
				dual CONNECT BY REGEXP_SUBSTR(V_EMPRESAS, '[^\|]+', 1, level) IS NOT NULL
		)
        AND TRUNC(A.FPOL) BETWEEN TO_DATE('01/01/2020', 'DD/MM/YYYY')
			AND TO_DATE(V_FECHA_INICIO, 'DD/MM/YYYY') - 1;

	V_SALDO NUMBER;
BEGIN
    OPEN C_SALDO_INICIO;
		FETCH C_SALDO_INICIO INTO V_SALDO;
	CLOSE C_SALDO_INICIO;

    RETURN V_SALDO;
END;--